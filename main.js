(()=>{"use strict";class t{constructor(){this.created=!1,this.updated=!1}onCreate(){}onUpdate(){}onRun(...t){}onFree(){}create(){if(this.created)return;const t=this.onCreate();return this.created=!0,t}update(){if(this.updated)return;this.create();const t=this.onUpdate();return this.updated=!0,t}run(...t){return this.update(),this.onRun(...t)}free(){if(!this.created)return;const t=this.onFree();return this.created=!1,this.updated=!1,t}}class e extends t{create(){if(this.initial.length){for(const t of this.initial)this.set(t);this.initial=[]}super.create()}constructor(t=[]){super(),this.initial=[],this.initial=t}}class i extends e{constructor(){super(...arguments),this.entities=[]}binSearch(t){this.update();let e=0,i=this.entities.length-1;for(;e<=i;){const n=e+Math.floor((i-e)/2);if(this.entities[n]._id===t)return n;this.entities[n]._id<t?e=n+1:i=n-1}return e}markForRemoval(t){const e=this.binSearch(t);this.entities[e]._id===t&&(this.markedForRemoval||(this.markedForRemoval=new Array(this.entities.length).fill(!1)),this.markedForRemoval[e]=!0,this.updated=!1)}removeMarked(){this.markedForRemoval&&(this.entities=this.entities.filter((t,e)=>!this.markedForRemoval[e],this),this.markedForRemoval=void 0)}unique(){this.entities=this.entities.filter((t,e)=>{var i;return 0===e||(null==t?void 0:t._id)!==(null===(i=this.entities[e-1])||void 0===i?void 0:i._id)})}set(t){this.entities.push(t),this.markedForRemoval&&this.markedForRemoval.push(!1),this.updated=!1}get(t){var e;const i=this.binSearch(t);if(this.entities[i]._id===t&&!(null===(e=this.markedForRemoval)||void 0===e?void 0:e[i]))return this.entities[i]}delete(t){this.markForRemoval(t);const e=this.binSearch(t);this.entities[e]._id===t&&(this.updated=!1)}clear(){this.entities=[],this.markedForRemoval=void 0}onCreate(){}onUpdate(){this.removeMarked(),this.entities.sort((t,e)=>t._id.localeCompare(e._id)),this.unique()}onRun(){return this.entities.values()}[Symbol.iterator](){return this.run()}onFree(){this.clear()}}const n=(new class{generate(t=12,e="0"){return Math.random().toString(36).substring(2).padStart(t,e)}}).generate;window.randomId=n;class s{constructor(){this.id=0}generate(t,e="0"){const i=String(this.id++);return t?i.padStart(t,e):i}}class r{generate(t=12,e="0"){let i=Date.now().toString(36);return i===r.last?r.count++:(r.count=0,r.last=i),i+=r.count.toString(36).padStart(4,"0"),i=i.padStart(t,e),i}}r.last="",r.count=0,(new r).generate;class o extends t{constructor(t){super(),this._id=t||`<unnamed system ${n()}>`}}class a extends o{constructor(t,e={}){super(t),this.managedQueries={},this.queries=e}free(){var t;for(const e in this.managedQueries)(null===(t=this.managedQueries[e])||void 0===t?void 0:t.created)&&this.managedQueries[e].free();super.free()}}class h extends a{constructor(t,e=[]){super(t,{}),this.children=new i(e),this._id=t}print(t=""){console.log(`${t}${this._id}`);for(const e of this.children)e instanceof h?e.print(t+"\t"):console.log(`${t}\t${e._id}`)}onCreate(){}onUpdate(){}onRun(...t){for(const e of this.children)e.run(...t)}onFree(){for(const t of this.children)(null==t?void 0:t.created)&&t.free()}}let u=()=>({emit(t,...e){for(let i=this.events[t]||[],n=0,s=i.length;n<s;n++)i[n](...e)},events:{},on(t,e){return(this.events[t]||=[]).push(e),()=>{this.events[t]=this.events[t]?.filter(t=>e!==t)}}});function l(t,e){for(const[i,n]of Object.entries(t))"_id"!==i&&e(i,n)}function d(t,e){return t[e]}class c extends(function(t){return class extends t{constructor(...t){super(...t),this.emitter=u()}on(t,e){return this.emitter.on(t,e)}emit(t,...e){return this.emitter.emit(t,...e)}}}(class{})){}function f(t,e){if(null==t)throw console.error(e,t),new Error(e);return!0}function m(t,e){return null!=t||(console.error(e,t),!1)}class p extends c{constructor(t){super(),this.emitter=u(),this.entities=new Map,null==t||t.forEach(t=>this.set(t))}set(t){const e=this.entities.get(t._id);e?this.setComponents(e,t):(this.entities.set(t._id,t),l(t,(e,i)=>{this.emit("add-component-"+e,t,i)}),this.emitter.emit("add-entity",t))}setUnique(t,e){const i=this.get(t);i?this.setComponent(i,t,e):this.set({_id:t,[t]:e})}getUnique(t){var e;return null===(e=this.get(t))||void 0===e?void 0:e[t]}setComponents(t,e){l(t,i=>{this._setComponent(t,i,e[i])}),this.emitter.emit("update-entity",t)}setComponent(t,e,i){this._setComponent(t,e,i),this.emit("update-entity",t)}setComponentById(t,e,i){const n=this.get(t);m(n,`Entity ${t} not found`),this.setComponent(n,e,i)}setComponentsById(t,e){const i=this.get(t);m(i,`Entity ${t} not found`),this.setComponents(i,e)}_setComponent(t,e,i){const n=void 0!==t[e],s=void 0!==i;n&&s&&i!==t[e]?(t[e]=i,this.emit("update-component-"+e,t,i)):n&&!s?(delete t[e],this.emit("delete-component-"+e,t)):!n&&s&&(t[e]=i,this.emit("add-component-"+e,t,i))}addComponent(t,e,i){t[e]=i,this.emit("add-component-"+e,t,i),this.emit("update-entity",t)}updateComponent(t,e,i){t[e]=i,this.emit("update-component-"+e,t,i),this.emit("update-entity",t)}deleteComponent(t,e){delete t[e],this.emit("delete-component-"+e,t),this.emit("update-entity, entity")}get(t){return this.entities.get(t)}deleteEntity(t){const e=this.entities.get(t);e&&(l(e,t=>{this.emit("delete-component-"+t,e)}),this.entities.delete(t),this.emit("delete-entity",e))}}const g=new p;window.entities=g.entities;class v extends h{constructor(t,e,i="initial"){super(t,[e[i]()]),this.scenes=e,this.initialState=i}onCreate(){g.setUnique(this._id,this.initialState),this.unbinder=g.on("update-component-"+this._id,(t,e)=>{console.warn("Switching to state",e);for(const t of this.children)t.free();this.children.free(),this.children=new i([this.scenes[e]()]),this.print()})}onFree(){var t;null===(t=this.unbinder)||void 0===t||t.call(this),g.deleteEntity(this._id),super.onFree()}}class w extends c{constructor(){super(...arguments),this.time=0,this.delta=0,this.frame=0,this.raf=null,this.boundLoop=this.loop.bind(this)}start(){this.time=performance.now(),this.emit("start",this),this.loop(this.time)}loop(t){this.raf=window.requestAnimationFrame(this.boundLoop),this.delta=t-this.time,this.time=t,this.emit("loop",this),this.frame++}pause(){null!==this.raf&&window.cancelAnimationFrame(this.raf),this.emit("pause",this)}}class x extends h{constructor(t,e,i){super(e,i),this.loop=function(t,e){const i=new t;return i.on("loop",t=>{e.run(t)}),i.start(),i}(t,this),this.print()}}class E extends x{constructor(t,e){super(w,t,e)}}new Float32Array([0,.5,0,-.4330126941204071,.25,0,-.4330126941204071,-.25,0,0,-.5,0,.4330126941204071,-.25,0,.4330126941204071,.25,0]),new Float32Array([0,.5,0,-.5,.25,0,-.5,-.25,0,0,-.5,0,.5,-.25,0,.5,.25,0]),new Float32Array([.5,0,0,.25,0,.75,.5,1,1,.75,1,.25]),new Uint16Array([0,1,5,5,1,4,4,2,3,2,4,1]);const _=new Float32Array([-.5,-.5,0,.5,-.5,0,-.5,.5,0,.5,.5,0]),T=(new Float32Array([-1,-1,0,1,-1,0,-1,1,0,1,1,0]),new Float32Array([0,1,1,1,0,0,1,0])),A=new Uint16Array([0,1,3,0,3,2]);class R extends t{constructor(t,e,i=g){var n;super(),this.unbinders=[],this._id=t,this.component=null!=e?e:t,this.world=i,this._=null===(n=i.get(t))||void 0===n?void 0:n[this.component],this.update()}onCreate(){const t=this.component;this.unbinders.push(this.world.emitter.on(`add-component-${t}`,e=>{this._=e[t]})),this.unbinders.push(this.world.emitter.on(`update-component-${t}`,e=>{this._=e[t]})),this.unbinders.push(this.world.emitter.on(`delete-component-${t}`,()=>{this._=void 0}))}onRun(){return this._}onFree(){for(const t of this.unbinders)t()}}class S extends t{constructor(t,e){var i,n,s,r;super(),this.glTexture=null,this.mipMap=!1,this.g=t;const o=t.gl,a=e||{},h=a.width||(null===(i=a.pixels)||void 0===i?void 0:i.naturalWidth)||(null===(n=a.pixels)||void 0===n?void 0:n.width),u=a.height||(null===(s=a.pixels)||void 0===s?void 0:s.naturalHeight)||(null===(r=a.pixels)||void 0===r?void 0:r.height);f(h&&u,"Texture: width and height must be specified"),this.width=h,this.height=u,this.minFilter=a.minFilter||o.LINEAR_MIPMAP_LINEAR,this.magFilter=a.magFilter||o.LINEAR,this.wrapS=a.wrapS||o.CLAMP_TO_EDGE,this.wrapT=a.wrapT||o.CLAMP_TO_EDGE,this.flip=a.flip||!1,this.premultiply=a.premultiply||!1,this.mipMap=a.mipMap,this.pixels=a.pixels||null,a.texture&&(this.glTexture=a.texture,this.created=!0)}onCreate(){const t=this.g.gl;this.glTexture=function(t,e,i,n){const s=Object.assign({framebuffer:null,pixels:null,minFilter:t.LINEAR,magFilter:t.LINEAR,wrapS:t.CLAMP_TO_EDGE,wrapT:t.CLAMP_TO_EDGE,flip:!1,premultiply:!1,glTexture:t.TEXTURE0,format:t.RGBA,internalFormat:n.format||t.RGBA,type:t.UNSIGNED_BYTE},n);var r=t.createTexture();return t.activeTexture(s.glTexture),t.bindTexture(t.TEXTURE_2D,r),s.flip?t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,1):t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,0),s.premultiply?t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0):t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),t.texImage2D(t.TEXTURE_2D,0,s.internalFormat,e,i,0,s.format,s.type,s.pixels||null),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,s.minFilter),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,s.magFilter),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,s.wrapS),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,s.wrapT),s.framebuffer&&(t.bindFramebuffer(t.FRAMEBUFFER,s.framebuffer),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,r,0)),r}(t,this.width,this.height,{pixels:this.pixels,minFilter:this.minFilter,magFilter:this.magFilter,wrapS:this.wrapS,wrapT:this.wrapT,flip:this.flip,premultiply:this.premultiply}),this.pixels&&(this.generateMipmap(),this.updated=!0)}generateMipmap(){const t=this.g.gl;(this.mipMap||void 0===this.mipMap&&[t.LINEAR_MIPMAP_LINEAR,t.LINEAR_MIPMAP_NEAREST,t.NEAREST_MIPMAP_LINEAR,t.NEAREST_MIPMAP_NEAREST].includes(this.minFilter))&&t.generateMipmap(t.TEXTURE_2D)}onUpdate(){if(this.pixels){const t=this.g.gl;t.bindTexture(t.TEXTURE_2D,this.glTexture),this.flip?t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,1):t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,0),this.premultiply?t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0):t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,this.width,this.height,0,t.RGBA,t.UNSIGNED_BYTE,this.pixels),this.generateMipmap()}}onRun(){return this.glTexture}onFree(){this.g.gl.deleteTexture(this.glTexture)}}class U extends t{constructor(t,e){super(),this.g=t,this.vertexBuffers=null!=e?e:{}}onCreate(){for(let t in this.vertexBuffers)this.vertexBuffers[t].create()}onUpdate(){for(let t in this.vertexBuffers)this.vertexBuffers[t].update()}onRun(t,e){this.g.run(),t.run(e);for(let e in t.attributeLocations)m(void 0!==this.vertexBuffers[e],`shader and geometry mismatch: buffer ${e} not found`)&&this.vertexBuffers[e].run(t.attributeLocations[e]);this.draw()}onFree(){for(let t in this.vertexBuffers)this.vertexBuffers[t].free()}}class F extends U{constructor(t,e){var i,n,s,r,o,a;super(t,null==e?void 0:e.vertexBuffers),this.indexBuffer=null,this.count=0,this.indexBuffer=null!==(i=null==e?void 0:e.indexBuffer)&&void 0!==i?i:null;const h=null!==(s=null===(n=this.indexBuffer)||void 0===n?void 0:n.type)&&void 0!==s?s:0,u=4&h||2&h||1;this.count=null!==(r=null==e?void 0:e.count)&&void 0!==r?r:this.indexBuffer?(null!==(a=null===(o=this.indexBuffer.data)||void 0===o?void 0:o.byteLength)&&void 0!==a?a:0)/u:0}onCreate(){var t;super.onCreate(),null===(t=this.indexBuffer)||void 0===t||t.create()}onUpdate(){var t,e,i,n,s;super.onUpdate(),m(this.indexBuffer,"Index buffer not set"),null===(t=this.indexBuffer)||void 0===t||t.update();const r=null!==(i=null===(e=this.indexBuffer)||void 0===e?void 0:e.type)&&void 0!==i?i:0,o=4&r||2&r||1;this.count=this.count||(this.indexBuffer?(null!==(s=null===(n=this.indexBuffer.data)||void 0===n?void 0:n.byteLength)&&void 0!==s?s:0)/o:0)}onFree(){var t;null===(t=this.indexBuffer)||void 0===t||t.free(),super.free(),this.count=0}draw(){var t;const e=this.g.gl;e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null===(t=this.indexBuffer)||void 0===t?void 0:t.glBuffer),e.drawElements(e.TRIANGLES,this.count,e.UNSIGNED_SHORT,0)}}class C extends F{constructor(t,e){var i,n;super(t,e),this.instanceBuffers={},this.instanceCount=0,this.instanceBuffers=null!==(i=null==e?void 0:e.instanceBuffers)&&void 0!==i?i:{},this.instanceCount=null!==(n=null==e?void 0:e.instanceCount)&&void 0!==n?n:0}onCreate(){super.onCreate();for(let t in this.instanceBuffers)this.instanceBuffers[t].create()}onUpdate(){super.onUpdate();for(let t in this.instanceBuffers)this.instanceBuffers[t].update()}enableAttributes(t,e){for(let i in t)void 0!==this.vertexBuffers[i]&&this.vertexBuffers[i].run(t[i]),void 0!==this.instanceBuffers[i]&&(this.instanceBuffers[i].run(t[i]),this.g.gl.vertexAttribDivisor(t[i],(null==e?void 0:e[i])||1))}onRun(t,e){this.g.run(),t.run(e),this.enableAttributes(t.attributeLocations),this.draw()}onFree(){for(let t in this.instanceBuffers)this.instanceBuffers[t].free();super.onFree()}draw(){var t;const e=this.g.gl;e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null===(t=this.indexBuffer)||void 0===t?void 0:t.glBuffer),e.drawElementsInstanced(e.TRIANGLES,this.count,e.UNSIGNED_SHORT,0,this.instanceCount)}}var B="undefined"!=typeof Float32Array?Float32Array:Array;Math.random,Math.PI,Math.PI;const P={5126:"1f",35674:"Matrix2fv",35675:"Matrix3fv",35676:"Matrix4fv",35664:"2fv",35665:"3fv",35666:"4fv",36336:"1f",5131:"1f",36338:"1f",36337:"1f",5124:"1i",35667:"2iv",35668:"3iv",35669:"4iv",5125:"1ui",36294:"2uiv",36295:"3uiv",36296:"4uiv",35670:"1i",35671:"2iv",35672:"3iv",35673:"4iv",35678:"Texture"};var L;function N(t,e,i){var n=t.createShader(e);if(t.shaderSource(n,i),t.compileShader(n),!t.getShaderParameter(n,t.COMPILE_STATUS)){const e="Shader compilation error: "+t.getShaderInfoLog(n);throw t.deleteShader(n),new Error(e)}return n}!function(t){t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1}((L=new B(16),B!=Float32Array&&(L[1]=0,L[2]=0,L[3]=0,L[4]=0,L[6]=0,L[7]=0,L[8]=0,L[9]=0,L[11]=0,L[12]=0,L[13]=0,L[14]=0),L[0]=1,L[5]=1,L[10]=1,L[15]=1,L));class b extends t{constructor(t,e,i){super(),this.glVertexShader=null,this.glFragmentShader=null,this.glProgram=null,this.attributeNames=[],this.attributeLocations={},this.uniformNames=[],this.uniforms={},this.matrixUniforms={},this.textureUniforms={},this.uniformLocations={},this.g=t,this.vertexShader=e,this.fragmentShader=i}onCreate(){const t=this.g.gl;this.glVertexShader=N(t,t.VERTEX_SHADER,this.vertexShader),this.glFragmentShader=N(t,t.FRAGMENT_SHADER,this.fragmentShader),this.glProgram=function(t,e,i){var n=t.createProgram();if(t.attachShader(n,e),t.attachShader(n,i),t.linkProgram(n),!t.getProgramParameter(n,t.LINK_STATUS)){const e="Program linking error: "+t.getProgramInfoLog(n);throw t.deleteProgram(n),new Error(e)}return n}(t,this.glVertexShader,this.glFragmentShader);const e=this.glProgram,i=t.getProgramParameter(e,t.ACTIVE_ATTRIBUTES);for(let n=0;n<i;n++){const i=t.getActiveAttrib(e,n).name;this.attributeNames.push(i)}this.attributeLocations=function(t,e,...i){return i.reduce((i,n)=>Object.assign(Object.assign({},i),{[n]:t.getAttribLocation(e,n)}),{})}(t,e,...this.attributeNames);const n=t.getProgramParameter(e,t.ACTIVE_UNIFORMS);this.uniforms={};for(let i=0;i<n;i++){const n=t.getActiveUniform(e,i),s=n.name,r=n.type,o=P[r];m(void 0!==o,`Uniform type not supported: ${s}: ${r}`),void 0!==o&&(this.uniformNames.push(s),this.uniforms[s]=o)}this.matrixUniforms={},this.uniformNames.filter(t=>this.uniforms[t].startsWith("Matrix")).forEach(t=>{this.matrixUniforms[t]=this.uniforms[t]}),this.textureUniforms={},this.uniformNames.filter(t=>"Texture"===this.uniforms[t]).forEach(t=>{this.textureUniforms[t]=this.uniforms[t]}),this.uniformLocations=function(t,e,...i){return i.reduce((i,n)=>Object.assign(Object.assign({},i),{[n]:t.getUniformLocation(e,n)}),{})}(t,e,...this.uniformNames)}setTextureUniform(t,e,i){const n=this.g.gl;n.activeTexture(n.TEXTURE0+t),n.bindTexture(n.TEXTURE_2D,i.run()),n.uniform1i(this.uniformLocations[e],t)}setUniforms(t){if(!t)return;let e=0;for(let i=0;i<this.uniformNames.length;i++){const n=this.uniformNames[i],s=this.uniforms[n],r=this.uniformLocations[n],o=t[n];void 0!==o&&(this.textureUniforms[n]?(this.setTextureUniform(e,n,o),e++):this.matrixUniforms[n]?this.g.gl[`uniform${s}`](r,!1,o):this.g.gl[`uniform${s}`](r,o))}}onRun(t){this.g.gl.useProgram(this.glProgram),this.setUniforms(t)}onFree(){const t=this.g.gl;if(this.glProgram&&t.deleteProgram(this.glProgram),this.glVertexShader&&t.deleteShader(this.glVertexShader),this.glFragmentShader&&t.deleteShader(this.glFragmentShader),this.attributeLocations)for(let e in this.attributeLocations)t.disableVertexAttribArray(this.attributeLocations[e])}}class y extends t{constructor(t,e){var i,n,s;super(),this.glBuffer=null,this.data=null,this.size=1,this.type=0,this.normalized=!1,this.stride=0,this.offset=0,this.target=0,this.usage=0,this.g=t;const r=t.gl;e&&Object.assign(this,e),this.type=null!==(i=null==e?void 0:e.type)&&void 0!==i?i:r.FLOAT,this.target=null!==(n=null==e?void 0:e.target)&&void 0!==n?n:r.ARRAY_BUFFER,this.usage=null!==(s=null==e?void 0:e.usage)&&void 0!==s?s:r.STATIC_DRAW}onCreate(){this.glBuffer=this.g.gl.createBuffer()}onUpdate(){const t=this.glBuffer,e=this.g.gl;e.bindBuffer(this.target,t),e.bufferData(this.target,this.data,this.usage)}onRun(t){const e=this.g.gl;return e.bindBuffer(this.target,this.glBuffer),e.enableVertexAttribArray(t),e.vertexAttribPointer(t,this.size,this.type,this.normalized,this.stride,this.offset),this.glBuffer}onFree(){this.g.gl.deleteBuffer(this.glBuffer),this.glBuffer=null}}function I(){var t=new B(2);return B!=Float32Array&&(t[0]=0,t[1]=0),t}function M(t,e){var i=new B(2);return i[0]=t,i[1]=e,i}I();const D={world:g,textures:new p,autoincrement:new s};class k extends t{constructor(t,e,i=g){super(),this.unbinders=[];const n=Array.isArray(e)?{include:e}:e;this.include=n.include,this.filter=n.filter,this.cleanup=n.cleanup,this.world=i,this.entities=new t}onCreate(){this.entities.create();for(const t of this.include)this.unbinders.push(this.world.emitter.on(`add-component-${t}`,t=>{this.filter&&!this.filter(t)||this.entities.set(t)})),this.unbinders.push(this.world.emitter.on(`delete-component-${t}`,e=>{this.cleanup&&this.cleanup(e,t),this.entities.delete(e._id)}));for(const t of this.world.entities.values())this.include.some(e=>void 0!==t[e])&&(this.filter&&!this.filter(t)||this.entities.set(t))}onUpdate(){this.entities.update()}onRun(){return this.entities.run()}[Symbol.iterator](){return this.run()}onFree(){for(const t of this.unbinders)t();this.entities.free()}}const O=new s;class $ extends a{constructor(t){super(null!=t?t:"tile-chunk-renderer-"+O.generate(6)),this.g=new R("main-g"),this.renderLoop=new R("render-loop"),this.camera=new R("map-camera2d"),this.managedQueries={chunkData:new k(i,["mapChunk"]),render:new k(i,{include:["mapChunkRender"],cleanup:this.cleanupComponents})},this.vertexBuffers={},this.shaders={};const e=this.g._;this.vertexBuffers={POSITION:new y(e,{data:_,size:3}),UV:new y(e,{data:T,size:2})},this.indexBuffer=new y(e,{data:A,target:e.gl.ELEMENT_ARRAY_BUFFER,type:e.gl.UNSIGNED_SHORT})}cleanupComponents(t){const e=d(t,"mapChunkRender"),i=d(t,"mapChunk");console.log("cleaning up render data for chunk",i),e.geometry.free()}onCreate(){const t=this.g.run(),e=this.camera.run(),i=D.textures.getUnique("tiles00.png");for(const n of this.managedQueries.chunkData.run()){const s=d(n,"mapChunk"),r=[],o=[];let a=0;const h=[];for(let t=0;t<s.data.length;t++){const e=s.data[t],n=g.get(`map-tile-${s.layer}-${e}`);if(!n){console.log(e);continue}const u=d(n,"mapTile");r.push(u.x/i.width,u.y/i.height),o.push(u.w/i.width,u.h/i.height);const l=t%s.width,c=s.height-~~(t/s.height),f=l+.5*(c%2+1),m=c+u.anchorY/u.h;h.push(f,m,.04*m),a++}const u={geometry:new C(t,{vertexBuffers:this.vertexBuffers,indexBuffer:this.indexBuffer,instanceBuffers:{INSTANCE_POSITION:new y(t,{data:new Float32Array(h),size:3}),INSTANCE_UV:new y(t,{data:new Float32Array(r),size:2}),INSTANCE_WH:new y(t,{data:new Float32Array(o),size:2})},instanceCount:a}),uniforms:{uCameraScale:e.scale,uCameraPosition:e.position,uTiles:i,uChunkPosition:M(s.x,-s.y)}};g.setComponent(n,"mapChunkRender",u),console.log(n)}this.shaders.main=new b(t,"#version 300 es\nin vec2 POSITION;\nin vec2 UV;\nin vec2 INSTANCE_POSITION;\nin vec2 INSTANCE_UV;\nin vec2 INSTANCE_WH;\n\nuniform vec2 uCameraPosition;\nuniform vec2 uCameraScale;\nuniform vec2 uChunkPosition;\n\nout vec2 vUV;\n\nvoid main() {\n    vec2 worldPos = (POSITION * vec2(1.02, INSTANCE_WH.y / INSTANCE_WH.x + 0.08) + (INSTANCE_POSITION + uChunkPosition))  * uCameraScale + uCameraPosition;\n    vUV = mix(INSTANCE_UV, INSTANCE_UV + INSTANCE_WH, UV);\n    gl_Position = vec4(worldPos, 0.0, 1.0);\n}\n","#version 300 es\nprecision highp float;\n\nuniform sampler2D uTiles;\n\nin vec2 vUV;\nout vec4 fragColor;\n\nvoid main() {\n    vec4 color = texture(uTiles, vUV);\n    if (color.a < 1.0) discard;\n    fragColor = color;\n}\n")}onRun(){const t=this.g._;!function(t,e){const i=t.gl;i.bindFramebuffer(i.FRAMEBUFFER,e.framebuffer),i.viewport(0,0,e.width,e.height)}(t,t);for(const t of this.managedQueries.render.run()){const e=d(t,"mapChunkRender");e.geometry.run(this.shaders.main,e.uniforms)}}onFree(){var t,e;this.g.free(),this.indexBuffer.free();for(const t of this.managedQueries.render.run())g.deleteComponent(t,"mapChunkRender");for(let e in this.vertexBuffers)null===(t=this.vertexBuffers[e])||void 0===t||t.free();for(let t in this.shaders)null===(e=this.shaders[t])||void 0===e||e.free()}}class G extends a{constructor(){super("window-resize-listener"),this.g=new R("main-g")}onResize(){const t=this.g.run();t.gl.canvas.width=window.innerWidth,t.gl.canvas.height=window.innerHeight}onCreate(){this.listener=this.onResize.bind(this),this.onResize(),window.addEventListener("resize",this.listener)}onFree(){window.removeEventListener("resize",this.listener)}}class z extends a{constructor(){super("main-camera-controller"),this.drag=!1,this.dragx=0,this.dragy=0,this.camera=new R("map-camera2d"),this.renderLoop=new R("render-loop"),this.onMouseDown=t=>{this.down(t.clientX,t.clientY)},this.onMouseUp=t=>{this.drag=!1},this.onMouseMove=t=>{this.move(t.clientX,t.clientY)},this.onResize=()=>{const t=window.innerHeight/window.innerWidth,e=this.camera._;e.scale[0]=e.scale[1]*(1.2*t)},g.setUnique("map-camera2d",{position:I(),scale:M(.125,.125)}),this.onResize()}move(t,e){if(this.drag){const i=t-this.dragx,n=e-this.dragy;this.dragx=t,this.dragy=e;const s=this.camera._;s.position[0]+=i/window.innerWidth*2,s.position[1]-=n/window.innerHeight*2}}down(t,e){this.drag=!0,this.dragx=t,this.dragy=e}onCreate(){this.camera.run(),this.renderLoop.run(),window.addEventListener("mousedown",this.onMouseDown),window.addEventListener("mouseup",this.onMouseUp),window.addEventListener("mousemove",this.onMouseMove),window.addEventListener("resize",this.onResize)}onFree(){this.camera.free(),this.renderLoop.free(),window.removeEventListener("mousedown",this.onMouseDown),window.removeEventListener("mouseup",this.onMouseUp),window.removeEventListener("mousemove",this.onMouseMove),window.removeEventListener("resize",this.onResize)}}class V extends h{constructor(){super("main-scene",[new G,new z,new $])}}class W extends t{get width(){return this.gl.canvas.width}set width(t){this.gl.canvas.width=t,this._aspect=this.height/this.width,this.updated=!1}get height(){return this.gl.canvas.height}set height(t){this._height=t,this._aspect=this.height/this.width,this.updated=!1}get aspect(){return this._aspect}constructor(t){super(),this.framebuffer=null,this._height=0,this._aspect=1,this.state={},this.toSet={},this.gl=t}onUpdate(){for(const t in this.toSet)this.state[t]=this.toSet[t],delete this.toSet[t]}set(t,e){this.state[t]!==e?this.toSet[t]=e:delete this.toSet[t]}get(t){return void 0!==this.toSet[t]?this.toSet[t]:this.state[t]}onRun(){return this}}const H=new s;class X extends h{constructor(){super("initial-scene"),this.loading=!1}onRun(){if(this.loading)return;this.loading=!0;const t=window.document.getElementById("canvas"),e=t.getContext("webgl2");f(e,"Fatal: Could not create webgl2 context");const i=new W(e);g.setUnique("main-canvas",t),g.setUnique("main-g",i),Promise.all([fetch("map.json").then(t=>t.json()),fetch("config/tiles.json").then(t=>t.json()),new Promise((t,e)=>{const i=new Image;i.onload=()=>{t(i)},i.onerror=t=>e(t),i.src="tiles00.png"}).then(t=>new S(i,{pixels:t,minFilter:i.gl.NEAREST_MIPMAP_NEAREST,magFilter:i.gl.NEAREST})).then(t=>{D.textures.setUnique("tiles00.png",t)})]).then(t=>{console.log(t),function(t){for(const e of t.layers)if(g.set({_id:`map-layer-${e.name}`,mapLayer:e}),"ground"===e.name)for(const t of e.chunks)g.set({_id:`map-chunk-${H.generate(4)}-${e.name}-${t.x}-${t.y}`,mapChunk:Object.assign(Object.assign({},t),{layer:e.name})})}(t[0]),function(t){for(const e of t)g.set({_id:`map-tile-${e.layer}-${e.tiledId}`,mapTile:e})}(t[1]),window.document.getElementById("root").innerHTML="",g.setUnique("global-scene-state-machine","main")})}}!function(){const t=new E("main-game-loop",[new h("001-global-state-machine",[new v("global-scene-state-machine",{initial:()=>new X,main:()=>new V})])]);g.setUnique("render-loop",t.loop)}()})();